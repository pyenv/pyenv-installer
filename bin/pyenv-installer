#!/usr/bin/env bash

set -e

# Defaults
if [ -z "$PYENV_ROOT" ]; then
  export PYENV_ROOT="$HOME/.pyenv"
fi
DEBUG=$PYENV_DEBUG

usage() {
  cat <<EOS
  Usage: $0 [-h] [-d] [-p <prefix>]

  -h            Print this help message and exit
  -d            Run in debug mode
  -p <prefix>   Specify installation directoy prefix. pyenv will
                get installed in <prefix>/.pyenv. Default value
                is $HOME.
EOS
}

while getopts ":hp:d" opt; do
  case $opt in
    h)
      usage
      exit 0
      ;;
    p)
      export PYENV_ROOT="$OPTARG/.pyenv"
      ;;
    d)
      DEBUG="TRUE"
      ;;
    ?)
      usage
      exit 1
      ;;
    :)
      usage
      exit 1
      ;;
  esac
done

checkout() {
  local repo="$1"
  local dest="$2"
  [ -d "${dest}" ] || git clone "${repo}" "${dest}"
}

install() {
  local repo="$1"
  checkout "${repo}" "${PYENV_ROOT}"
}

install_plugin() {
  local repo="$1"
  local name="$(basename "${repo}" ".git")"
  checkout "${repo}" "${PYENV_ROOT}/plugins/${name}"
}

if ! command -v git 1>/dev/null 2>&1; then
  echo "pyenv: Git is not installed, can't continue." 1>&2
  exit 1
fi

[ -n "$DEBUG" ] && set -x
install "https://github.com/yyuu/pyenv.git"
install_plugin "https://github.com/yyuu/pyenv-doctor.git"
install_plugin "https://github.com/yyuu/pyenv-installer.git"
install_plugin "https://github.com/yyuu/pyenv-pip-migrate.git"
install_plugin "https://github.com/yyuu/pyenv-pip-rehash.git"
install_plugin "https://github.com/yyuu/pyenv-update.git"
install_plugin "https://github.com/yyuu/pyenv-virtualenv.git"

if ! command -v pyenv 1>/dev/null 2>&1; then
  cat <<EOS
Seems you still have not added 'pyenv' to the load path:

export PYENV_ROOT="${PYENV_ROOT}"

if [ -d "${PYENV_ROOT}" ]; then
  export PATH="${PYENV_ROOT}/bin:\${PATH}"
  eval "\$(pyenv init -)"
fi
EOS
fi

